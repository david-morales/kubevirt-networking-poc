apiVersion: v1
kind: Secret
metadata:
  name: mongodb-vm-userdata
  namespace: {{ .Values.namespace }}
type: Opaque
stringData:
  userdata: |
    #cloud-config
    users:
      - name: neo
        plain_text_passwd: 'neo'
        lock_passwd: false
        groups: users, admin
        sudo: ALL=(ALL) NOPASSWD:ALL
    package_upgrade: true
    write_files:
      - content: |
          #!/bin/bash
          ansible-galaxy collection install -r requirements.yml
          collection install -r requirements.yml
          ansible-playbook /mnt/ansible-playbook/ansible_playbook.yml
        path: /root/run_ansible.sh
        permissions: '0755'
       content: |
          collections:
          - name: https://github.com/ansible-collections/community.mongodb.git
            type: git
            version: 1.6.1
        path: /root/requirements.yml
        permissions: '0755'
    ansible:
      package_name: ansible-core
      install_method: distro
      run_user: neo
    runcmd:
      - mkdir -p /mnt/mongodb-cert-tls && mount /dev/$(lsblk --nodeps -no name,serial | grep 1SERIAL | cut -f1 -d' ') /mnt/mongodb-cert-tls
      - mkdir -p /mnt/ansible-vars && mount /dev/$(lsblk --nodeps -no name,serial | grep 2SERIALANSIBLEVARS | cut -f1 -d' ') /mnt/ansible-vars
      - mkdir -p /mnt/ansible-playbook && mount /dev/$(lsblk --nodeps -no name,serial | grep 3SERIALANSIBLEPLAYBK | cut -f1 -d' ') /mnt/ansible-playbook
      - cp /mnt/mongodb-cert-tls/tls.crt /etc/ssl/tls.crt
      - cp /mnt/mongodb-cert-tls/tls.key /etc/ssl/tls.key
      - cp /mnt/mongodb-cert-tls/ca.crt /etc/ssl/ca.crt
      - cat /etc/ssl/tls.crt /etc/ssl/tls.key > /etc/ssl/mongodb.pem
      - /root/run_ansible.sh