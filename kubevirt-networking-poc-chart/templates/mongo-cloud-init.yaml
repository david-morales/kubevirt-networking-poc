apiVersion: v1
kind: Secret
metadata:
  name: mongodb-vm-userdata
  namespace: {{ .Values.namespace }}
type: Opaque
stringData:
  userdata: |
    #cloud-config
    users:
      - name: neo
        plain_text_passwd: 'neo'
        lock_passwd: false
        groups: users, admin
        sudo: ALL=(ALL) NOPASSWD:ALL
    hostname: mongodb-vm
    package_upgrade: true
    write_files:
      - content: |
          - hosts: localhost
            vars:
              config_port: 27017
              mongodb_repository: https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/6.0/x86_64/
              bind_ip: 0.0.0.0
              authorization: disabled
              mongodb_use_tls: true
              mongodb_certificate_key_file: /etc/ssl/mongodb.pem
              mongodb_certificate_ca_file: /etc/ssl/ca.crt
            roles:
              - community.mongodb.mongodb_repository
              - community.mongodb.mongodb_install
              - community.mongodb.mongodb_config
              - community.mongodb.mongodb_mongod
        path: /root/mongodb_replica_setup.yml
    ansible:
      package_name: ansible-core
      install_method: distro
      run_user: neo
      setup_controller:
        repositories:
          - path: /root
            source: https://github.com/ansible/ansible
      galaxy:
        actions:
          - ['install', 'community.mongodb']
      run_ansible:
        - playbook_name: /root/mongodb_replica_setup.yml
    runcmd:
      - mkdir -p /mnt/mongodb-cert-tls && mount /dev/$(lsblk --nodeps -no name,serial | grep SERIAL | cut -f1 -d' ') /mnt/mongodb-cert-tls
      - cp /mnt/mongodb-cert-tls/tls.crt /etc/ssl/tls.crt
      - cp /mnt/mongodb-cert-tls/tls.key /etc/ssl/tls.key
      - cp /mnt/mongodb-cert-tls/ca.crt /etc/ssl/ca.crt
      - cat /etc/ssl/tls.crt /etc/ssl/tls.key > /etc/ssl/mongodb.pem
