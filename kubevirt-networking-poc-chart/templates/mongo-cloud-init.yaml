apiVersion: v1
kind: Secret
metadata:
  name: mongodb-vm-userdata
  namespace: {{ .Values.namespace }}
type: Opaque
stringData:
  userdata: |
    #cloud-config
    users:
      - name: neo
        plain_text_passwd: 'neo'
        lock_passwd: false
        groups: users, admin
        sudo: ALL=(ALL) NOPASSWD:ALL
    package_upgrade: true
    write_files:
      - content: |
          - hosts: localhost
            pre_tasks:
              - name: Include Ansible vars
                include_vars:
                  file: /mnt/ansible-vars/ansible_vars.yml
              - name: Generate members list
                set_fact:
                  members_list: >-
                    {%- set result = [] -%}
                    {%- for i in range(replicaset_size) -%}
                      {%- set _ = result.append('mongodb-' ~ i ~ '.' ~ namespace ~ '.svc.cluster.local:' ~ config_port) -%}
                    {%- endfor -%}
                    '{{ "{{ result }}" }}'
            roles:
              - community.mongodb.mongodb_repository
              - community.mongodb.mongodb_install
              - community.mongodb.mongodb_mongod
            post_tasks:
              - name: Install python-setuptools
                package:
                  name: python-setuptools
                  state: latest
                  update_cache: yes
              - name: Install python-pip
                package:
                  name: python-pip
                  state: latest
              - name: Ensure pymongo is installed
                pip:
                  name: pymongo>2.4.2
                  state: present
              - name: Ensure replicaset exists
                community.mongodb.mongodb_replicaset:
                  login_host: 'mongodb-0."{{ namespace }}".svc.cluster.local'
                  login_port: '{{ "{{ config_port }}" }}'
                  ssl: true
                  ssl_certfile: '{{ "{{ mongodb_certificate_key_file }}" }}'
                  ssl_ca_certs: '{{ "{{ mongodb_certificate_ca_file }}" }}'
                  replica_set: '{{ "{{ replicaset_name }}" }}'                  
                  members:
                    members: '{{ "{{ members_list }}" }}'
                  validate: no
                when: ansible_hostname is search("-0")               
              - name: Wait for the replicaset to stabilise
                community.mongodb.mongodb_status:
                  login_host: 'mongodb-0.{{ namespace }}.svc.cluster.local'
                  login_port: '{{ "{{ config_port }}" }}'
                  ssl: true
                  ssl_certfile: '{{ "{{ mongodb_certificate_key_file }}" }}'
                  ssl_ca_certs: '{{ "{{ mongodb_certificate_ca_file }}" }}'
                  replica_set: '{{ "{{ replicaset_name }}" }}'
                  poll: 5
                  interval: 10
                  validate: minimal
                when: ansible_hostname is search("-0")         
        path: /root/mongodb_replica_setup.yml
      - content: |
          #!/bin/bash
          ansible-galaxy collection install community.mongodb
          ansible-playbook /root/mongodb_replica_setup.yml
        path: /root/run_ansible.sh
        permissions: '0755'
    ansible:
      package_name: ansible-core
      install_method: distro
      run_user: neo
    runcmd:
      - mkdir -p /mnt/mongodb-cert-tls && mount /dev/$(lsblk --nodeps -no name,serial | grep 1SERIAL | cut -f1 -d' ') /mnt/mongodb-cert-tls
      - mkdir -p /mnt/ansible-vars && mount /dev/$(lsblk --nodeps -no name,serial | grep 2SERIALANSIBLEVARS | cut -f1 -d' ') /mnt/ansible-vars
      - cp /mnt/mongodb-cert-tls/tls.crt /etc/ssl/tls.crt
      - cp /mnt/mongodb-cert-tls/tls.key /etc/ssl/tls.key
      - cp /mnt/mongodb-cert-tls/ca.crt /etc/ssl/ca.crt
      - cat /etc/ssl/tls.crt /etc/ssl/tls.key > /etc/ssl/mongodb.pem
      - /root/run_ansible.sh